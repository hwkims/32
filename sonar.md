# STM32F429I-Discovery: Servo Control + Ultrasonic Sensor (HC-SR04) Demo

This repository contains firmware for the **STM32F429I-Discovery** board demonstrating simultaneous control of a standard hobby servo motor and distance measurement using an HC-SR04 ultrasonic sensor. The measured distance is printed to the serial console (UART).

The project utilizes the STMicroelectronics HAL libraries and is likely configured using STM32CubeMX/CubeIDE.

## Hardware Requirements

*   **STM32F429I-Discovery** development board
*   **Standard Hobby Servo Motor** (e.g., SG90, MG996R - position control type, not continuous rotation)
*   **HC-SR04 Ultrasonic Distance Sensor** (or similar 4-pin model)
*   **Jumper Wires**
*   USB cable (Type-A to Mini-B) for programming (ST-LINK) and power
*   **(Optional but Recommended)** A separate **5V Power Supply** for the servo motor to avoid overloading the board's regulator.
*   **(Optional)** USB-to-Serial adapter (e.g., FTDI, CP2102) for viewing `printf` output via UART1.

## Software & Tools

*   **STM32CubeIDE** (Recommended, as the project structure appears generated by it)
    *   Or a compatible toolchain (Keil MDK, IAR EWARM) capable of importing STM32CubeMX projects.
*   STMicroelectronics HAL Libraries (Included/Managed by CubeIDE/CubeMX)
*   Serial terminal emulator (like PuTTY, Tera Term, Minicom) for viewing distance readings.

## Key Features

*   **Servo Motor Control:**
    *   Uses **TIM4 Channel 3 PWM Output** (connected to pin **PB8**) to control the servo position.
    *   Includes basic logic (in `HAL_TIM_PWM_PulseFinishedCallback`) to toggle the servo between two positions periodically (modify this logic for different movements like sweeping).
*   **Ultrasonic Distance Sensing (HC-SR04):**
    *   **Trig Pulse Generation:** Uses a dedicated **GPIO Output pin** (e.g., **PC0** in the example code) to send the 10us trigger pulse.
    *   **Echo Pulse Measurement:** Uses **TIM1 Channel 1 Input Capture** (connected to pin **PE9** in the example code) to precisely measure the duration (in microseconds) of the returning echo pulse. Leverages timer interrupts (`HAL_TIM_IC_CaptureCallback`).
    *   **Distance Calculation:** Converts the measured echo pulse duration into distance in centimeters (`duration_us / 58.0`).
*   **Combined Operation:** The main loop periodically triggers the sonar measurement, waits for the result (with a basic timeout), calculates the distance, and prints it, while the servo continues its movement based on the TIM4 PWM interrupt.
*   **Microsecond Delay:** Uses TIM1 base timer (configured for 1MHz) for `delay_us` function.
*   **Debugging Output:** Redirects `printf` output to UART1 (USART1: PA9=TX, PA10=RX, Baud Rate: 115200) to display the measured distance.

## Hardware Connections

**(Important: Verify pin assignments in your specific CubeMX configuration and code defines!)**

1.  **Servo Motor:**
    *   **Signal Pin:** Connect to **PB8** (TIM4_CH3 output - P1 Connector Pin 16).
    *   **VCC Pin:** Connect to **5V**. (Using an external 5V supply is recommended. If using external supply, connect its GND to the Discovery board's GND).
    *   **GND Pin:** Connect to **GND** on the Discovery board.
2.  **HC-SR04 Sensor:**
    *   **VCC Pin:** Connect to **5V** on the Discovery board.
    *   **GND Pin:** Connect to **GND** on the Discovery board.
    *   **Trig Pin:** Connect to the GPIO Output pin defined in the code (e.g., **PC0** - defined as `TRIG_PORT`/`TRIG_PIN`).
    *   **Echo Pin:** Connect to the TIM1 Input Capture pin defined in the code (e.g., **PE9** for TIM1_CH1 - P2 Connector Pin 1).

## Getting Started

1.  **Clone the repository:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-directory>
    ```
2.  **Open the project:**
    *   Launch STM32CubeIDE.
    *   Go to `File` > `Open Projects from File System...`.
    *   Select the cloned project directory.
    *   Click `Finish`.
3.  **Verify CubeMX Configuration (.ioc file):**
    *   **Crucial Step:** Double-click the `.ioc` file in the Project Explorer.
    *   Check that **TIM4 CH3** is configured as **PWM Generation CH3** and linked to **PB8**.
    *   Check that the **Trig pin** (e.g., PC0) is configured as **GPIO_Output**.
    *   Check that the **Echo pin** (e.g., PE9) is configured for the correct **TIM1 Channel Input Capture** (e.g., `TIM1_CH1`).
    *   Verify **TIM1** base clock is set up (e.g., Prescaler 83 for 1MHz) and the corresponding **Input Capture channel** is enabled (`Input Capture direct mode`, Polarity: `Rising Edge`).
    *   Ensure the **TIM1 Capture Compare interrupt** is **enabled** in the `NVIC Settings`.
    *   If any settings are incorrect, fix them in CubeMX and **regenerate the code** (`Project` > `Generate Code`).
4.  **Connect the board:** Connect your STM32F429I-Discovery board via ST-LINK USB.
5.  **Connect Hardware:** Wire the Servo and HC-SR04 sensor according to the "Hardware Connections" section *after verifying your pin configuration*.
6.  **Build the project:** `Project` > `Build Project` (Ctrl+B).
7.  **Flash the firmware:** `Run` > `Run As` > `STM32 Application` (or use Debug).
8.  **(Optional) Connect Serial Terminal:**
    *   Connect your USB-to-Serial adapter (TX to PA10, RX to PA9, GND to GND).
    *   Open your serial terminal program (PuTTY, etc.).
    *   Configure it for the correct COM port at **115200 baud, 8N1**.
9.  **Observe:**
    *   The servo motor should start moving between two positions (or according to your modified logic).
    *   The serial terminal should display distance readings like "Distance: xx.xx cm (Duration: yyyy us)".

## Code Notes

*   The servo movement logic is currently within `HAL_TIM_PWM_PulseFinishedCallback`.
*   The ultrasonic echo measurement happens within `HAL_TIM_IC_CaptureCallback`.
*   The main loop in `main.c` coordinates the triggering (`Trigger_Sonar`) and result processing.
*   `volatile` keywords are used for variables shared between the main loop and interrupt service routines (`Capture_Done`, `Difference`, etc.).
*   A simple polling wait with a timeout (`while(!Capture_Done && ... )`) is used in the main loop. For more complex applications, non-blocking methods or an RTOS might be better.

## Author

*   **hwkims (KIM HYUN WOO)**

## License

*(Optional: Add license information here if desired)*
